rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 認証チェック
    function isAuthenticated() {
      return request.auth != null;
    }

    // 1000ri.jpドメインのユーザーのみ許可
    function isAllowedDomain() {
      return request.auth != null &&
             request.auth.token.email != null &&
             request.auth.token.email.matches('.*@1000ri\\.jp$');
    }

    // 認証済み + 許可ドメインのチェック
    function isAllowedUser() {
      return isAuthenticated() && isAllowedDomain();
    }

    // プロジェクトメンバーかどうかチェック（membersサブコレクション）
    function isProjectMemberByDoc(projectId) {
      return exists(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid));
    }

    // プロジェクトメンバーかどうかチェック（memberIds配列）
    function isProjectMemberByArray(projectId) {
      return request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberIds;
    }

    // いずれかの方法でメンバーであればOK
    function canAccessProject(projectId) {
      return isAllowedUser() && (isProjectMemberByDoc(projectId) || isProjectMemberByArray(projectId));
    }

    // ユーザードキュメント
    match /users/{userId} {
      allow read: if isAllowedUser();
      allow write: if isAllowedUser() && request.auth.uid == userId;
      allow create: if isAllowedUser();

      // 個人AI会話（相棒AI - 旧パス）
      match /personalConversations/{conversationId} {
        allow read, write: if isAllowedUser() && request.auth.uid == userId;

        match /messages/{messageId} {
          allow read, write: if isAllowedUser() && request.auth.uid == userId;
        }
      }

      // 統合AI会話（相棒AI - 新パス）
      match /conversations/{conversationId} {
        allow read, write: if isAllowedUser() && request.auth.uid == userId;

        match /messages/{messageId} {
          allow read, write: if isAllowedUser() && request.auth.uid == userId;
        }
      }

      // AI設定（APIキーなど） - 本人のみアクセス可
      match /settings/{settingId} {
        allow read, write: if isAllowedUser() && request.auth.uid == userId;
      }
    }

    // プロジェクト - メンバーのみアクセス可能
    match /projects/{projectId} {
      // プロジェクトの読み取りはメンバーのみ
      // memberIdsフィールドでのクエリもサポート（クロスプロジェクト検索用）
      allow read: if canAccessProject(projectId) ||
                     (isAllowedUser() && request.auth.uid in resource.data.memberIds);
      // プロジェクトの作成は許可ドメインの全ユーザー
      allow create: if isAllowedUser();
      // プロジェクトの更新・削除はメンバーのみ
      allow update, delete: if canAccessProject(projectId);

      // メンバー管理
      match /members/{memberId} {
        // メンバー一覧の読み取りはプロジェクトメンバーのみ
        allow read: if canAccessProject(projectId);
        // メンバーの追加はプロジェクトメンバーのみ（最初のメンバーはプロジェクト作成時に追加）
        allow write: if isAllowedUser();
      }

      match /lists/{listId} {
        allow read, write: if canAccessProject(projectId);
      }

      match /tasks/{taskId} {
        allow read, write: if canAccessProject(projectId);

        match /comments/{commentId} {
          allow read, write: if canAccessProject(projectId);
        }

        match /checklists/{checklistId} {
          allow read, write: if canAccessProject(projectId);
        }

        match /attachments/{attachmentId} {
          allow read, write: if canAccessProject(projectId);
        }
      }

      match /labels/{labelId} {
        allow read, write: if canAccessProject(projectId);
      }

      match /tags/{tagId} {
        allow read, write: if canAccessProject(projectId);
      }

      // アクティビティログ
      match /activityLogs/{logId} {
        allow read, write: if canAccessProject(projectId);
      }

      // AI会話
      match /aiConversations/{conversationId} {
        allow read, write: if canAccessProject(projectId);

        match /messages/{messageId} {
          allow read, write: if canAccessProject(projectId);
        }
      }

      // 旧形式のconversations
      match /conversations/{conversationId} {
        allow read, write: if canAccessProject(projectId);

        match /messages/{messageId} {
          allow read, write: if canAccessProject(projectId);
        }
      }
    }

    // 通知
    match /notifications/{notificationId} {
      allow read: if isAllowedUser() && resource.data.userId == request.auth.uid;
      allow create: if isAllowedUser();
      allow update, delete: if isAllowedUser() && resource.data.userId == request.auth.uid;
    }

    // ユーザーメモ - 本人のみ
    match /userMemos/{memoId} {
      allow read, write: if isAllowedUser() && resource.data.userId == request.auth.uid;
      allow create: if isAllowedUser();
    }
  }
}
